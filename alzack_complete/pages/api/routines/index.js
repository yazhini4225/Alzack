import prisma from '../../../lib/prisma'; import { verifyToken } from '../../../lib/auth'
async function getUser(req){ const cookie = req.headers.cookie || ''; const match = cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('alzack_token=')); if(!match) return null; const token = match.split('=')[1]; return verifyToken(token) }
export default async function handler(req,res){ const payload = await getUser(req); if(!payload) return res.status(401).json({error:'not auth'}); const user = await prisma.user.findUnique({ where:{ id: payload.userId } }); if(req.method==='GET'){ if(user.role!=='PATIENT') return res.status(403).json([]); const list = await prisma.routine.findMany({ where:{ patientId: user.patientId } }); return res.json(list) } if(req.method==='POST'){ if(user.role!=='PATIENT') return res.status(403).json({error:'only patient'}); const { title, details, time } = req.body; const t = new Date(time); const r = await prisma.routine.create({ data:{ title, details, time: t, snoozeMins:5, patientId: user.patientId } }); const list = await prisma.routine.findMany({ where:{ patientId: user.patientId } }); return res.json(list) } res.status(405).end() }
